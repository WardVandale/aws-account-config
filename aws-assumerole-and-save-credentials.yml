---
  - name: Assumerole and Save credentials
    block:
      - name: Assume role for subaccounts
        sts_assume_role:
          role_arn: "arn:aws:iam::{{ item.account_id }}:role/{{ item.sts_role | default('OrganizationAccountAccessRole') }}"
          role_session_name: "{{ item.name }}-{{ item.sts_role | default('OrgAccAccRole') }}"
        register: "monitoring_assumed_role_subaccount_single"
        with_items:
          - "{{ subaccounts }}"

      - name: Create assumerole cache files
        template:
          src: "assumerole-cache.j2"
          dest: "/Users/rik/.assumerole.d/cache/{{ item.item.name }}"
        with_items:
          - "{{ monitoring_assumed_role_subaccount_single.results }}"

      - name: Create config scripts
        template:
          src: "update-aws-cfn-gen.j2"
          dest: "/Users/rik/projects/AWSAccountConfigsIxor/scripts/{{ item.item.name }}.bash"
          mode: 0755
        with_items:
          - "{{ monitoring_assumed_role_subaccount_single.results }}"

    tags: [ 'assumerole' ]

